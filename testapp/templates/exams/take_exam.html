<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>{{ exam.title }}</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 50px; 
            text-align: center; 
            background-color: #f0f2f5;
        }
        .question-card, .intro-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 700px;
            margin: auto;
            display: none; 
        }
        .question-card.active, .intro-card.active {
            display: block; 
        }
        h2 { color: #2c3e50; font-size: 2.5em; margin-bottom: 20px; }
        .status { 
            font-size: 1.5em; color: #27ae60; margin-top: 20px; font-weight: bold; min-height: 40px;
        }
        .instructions { color: #7f8c8d; margin-top: 30px; font-size: 0.9em; }
        audio { display: none; }
    </style>
</head>
<body>

    <h1 style="color: #333;">{{ exam.title }}</h1>

    <div class="intro-card active" id="intro-card">
        <h2>Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</h2>
        <p style="font-size: 1.5em; color: #555;">Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª...</p>
        <p>Ø§Ø¶ØºØ· Ù…Ø³Ø§ÙØ© Ø£Ùˆ Ø¥Ù†ØªØ± Ù„ØªØ®Ø·ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙˆØ§Ù„Ø¨Ø¯Ø¡.</p>
        {% if exam.audio_file %}
            <audio id="intro-audio" src="{{ exam.audio_file.url }}"></audio>
        {% endif %}
    </div>

    <form method="POST" enctype="multipart/form-data" id="examForm">
        {% csrf_token %}
        
        {% for question in questions %}
            <div class="question-card" id="q-card-{{ forloop.counter0 }}">
                <h2>Ø³Ø¤Ø§Ù„ {{ forloop.counter }}:</h2>
                <p style="font-size: 2em; color: #007bff;">{{ question.text }}</p>
                
                {% if question.audio_file %}
                    <audio id="q-audio-{{ forloop.counter0 }}" src="{{ question.audio_file.url }}"></audio>
                {% else %}
                    <p style="color:red;">(Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ØµÙˆØªÙŠ)</p>
                {% endif %}

                <div id="status-{{ forloop.counter0 }}" class="status"></div>
                
                <input type="file" name="audio_data" id="file-{{ forloop.counter0 }}" style="display: none;">
                <input type="hidden" name="question_id" value="{{ question.id }}">
            </div>
        {% endfor %}

        <button type="submit" id="submit-all" style="display: none;">Ø§Ø±Ø³Ø§Ù„</button>
    </form>

    <div class="instructions">
        <p><strong>Ø§Ù„Ù…Ø³Ø§ÙØ© (1):</strong> ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ | <strong>Ø§Ù„Ù…Ø³Ø§ÙØ© (2):</strong> ØªØ³Ø¬ÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù | <strong>Enter:</strong> Ø­ÙØ¸ ÙˆØ§Ù„ØªØ§Ù„ÙŠ</p>
    </div>

    <script>
        const cards = document.querySelectorAll('.question-card');
        const introCard = document.getElementById('intro-card');
        const introAudio = document.getElementById('intro-audio');
        
        let currentIndex = 0;
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let lastSpacePressTime = 0;
        let isExamStarted = false; // Ù‡Ù„ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ÙˆØ¨Ø¯Ø£Ù†Ø§ØŸ

        // --- 1. Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ---
        window.onload = function() {
            if (introAudio) {
                introAudio.play().catch(e => console.log("Ø§Ù†ØªØ¸Ø§Ø± ØªÙØ§Ø¹Ù„"));
                // Ù„Ù…Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ØªØ®Ù„ØµØŒ Ø§Ø¯Ø®Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„
                introAudio.onended = startExam;
            } else {
                startExam();
            }
        };

        function startExam() {
            if (isExamStarted) return;
            isExamStarted = true;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø£ÙˆÙ„ Ø³Ø¤Ø§Ù„
            introCard.classList.remove('active');
            if(introAudio) { introAudio.pause(); }
            
            if (cards.length > 0) {
                showQuestion(0);
            } else {
                speakSimple("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©");
            }
        }

        // --- 2. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ---
        function showQuestion(index) {
            stopAllAudio();
            cards.forEach(c => c.classList.remove('active'));
            cards[index].classList.add('active');
            playQuestionAudio(index);
        }

        function playQuestionAudio(index) {
            let audio = document.getElementById(`q-audio-${index}`);
            if (audio) {
                audio.currentTime = 0;
                audio.play();
            }
        }

        function stopAllAudio() {
            document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime = 0; });
            window.speechSynthesis.cancel();
        }

        // --- 3. Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ---
        document.addEventListener('keydown', function(event) {
            
            // Ù„Ùˆ Ù„Ø³Ù‡ ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©ØŒ Ø£ÙŠ Ø²Ø±Ø§Ø± ÙŠØ¯Ø®Ù„Ù‡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
            if (!isExamStarted && (event.code === 'Space' || event.code === 'Enter')) {
                event.preventDefault();
                startExam();
                return;
            }

            // Ø²Ø± Ø§Ù„Ù…Ø³Ø§ÙØ© (Space)
            if (event.code === 'Space') {
                event.preventDefault();
                let currentTime = new Date().getTime();
                
                if (currentTime - lastSpacePressTime < 300) {
                    toggleRecording(); // Ø¶ØºØ·ØªÙŠÙ†: ØªØ³Ø¬ÙŠÙ„
                    lastSpacePressTime = 0;
                } else {
                    lastSpacePressTime = currentTime;
                    setTimeout(() => {
                        if (new Date().getTime() - lastSpacePressTime >= 300 && lastSpacePressTime !== 0) {
                            if (!isRecording) {
                                stopAllAudio();
                                playQuestionAudio(currentIndex); // Ø¶ØºØ·Ø©: Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø³Ø¤Ø§Ù„
                            }
                        }
                    }, 350);
                }
            }

            // Ø²Ø± Ø§Ù„Ø¥Ù†ØªØ± (Enter): Ø­ÙØ¸ ÙˆØ§Ù†ØªÙ‚Ø§Ù„
            if (event.code === 'Enter') {
                event.preventDefault();
                handleEnterKey();
            }

            // Ø§Ù„Ø£Ø³Ù‡Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ùˆ Ø­Ø¨ ÙŠØ±Ø¬Ø¹ ÙŠØ±Ø§Ø¬Ø¹)
            if (event.code === 'ArrowRight') { // Ø§Ù„Ø³Ø§Ø¨Ù‚
                if (currentIndex > 0) {
                    stopRecordingIfActive();
                    currentIndex--;
                    showQuestion(currentIndex);
                }
            }
        });

        // --- 4. Ù…Ù†Ø·Ù‚ Ø²Ø± Ø§Ù„Ø¥Ù†ØªØ± (Ø§Ù„Ø¬ÙˆÙ‡Ø±) ---
        function handleEnterKey() {
            // 1. Ù„Ùˆ Ø¨ÙŠØ³Ø¬Ù„ØŒ ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ø­ÙØ¸Ù‡
            if (isRecording) {
                toggleRecording(); // Ø¯ÙŠ Ù‡ØªÙˆÙ‚Ù ÙˆØªØ­ÙØ¸ Ø§Ù„Ù…Ù„Ù
                // Ù†Ø¯ÙŠ Ù…Ù‡Ù„Ø© ØµØºÙŠØ±Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ø­ÙØ¸ ÙŠØªÙ… Ù‚Ø¨Ù„ Ø§Ù„Ù†Ù‚Ù„
                setTimeout(nextQuestionOrSubmit, 500);
            } else {
                // Ù„Ùˆ Ù…Ø´ Ø¨ÙŠØ³Ø¬Ù„ØŒ Ø§Ù†Ù‚Ù„ Ø¹Ù„Ø·ÙˆÙ„
                nextQuestionOrSubmit();
            }
        }

        function nextQuestionOrSubmit() {
            // Ù‡Ù„ ÙÙŠÙ‡ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø³Ø¬Ù„Ø©ØŸ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ù…Ù…ÙƒÙ† ØªÙ†Ø¨Ù‡Ù‡ Ù„Ùˆ Ù…ÙÙŠØ´ Ù…Ù„Ù)
            let fileInput = document.getElementById(`file-${currentIndex}`);
            
            if (currentIndex < cards.length - 1) {
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
                speakSimple("ØªÙ… Ø§Ù„Ø­ÙØ¸ØŒ Ø§Ù„ØªØ§Ù„ÙŠ");
                currentIndex++;
                setTimeout(() => showQuestion(currentIndex), 1000);
            } else {
                // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                stopAllAudio();
                speakSimple("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
                setTimeout(() => {
                    document.getElementById('submit-all').click();
                }, 2000);
            }
        }

        // --- 5. Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ---
        async function toggleRecording() {
            if (!isRecording) {
                // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                stopAllAudio();
                try {
                    let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    
                    mediaRecorder.onstop = () => {
                        // Ù‡Ù†Ø§ Ø¨ÙŠØªÙ… "Ø§Ø³ØªØ¨Ø¯Ø§Ù„" Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Overwrite)
                        let audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        let file = new File([audioBlob], `ans_${currentIndex}.wav`, { type: "audio/wav" });
                        let container = new DataTransfer();
                        container.items.add(file);
                        document.getElementById(`file-${currentIndex}`).files = container.files;
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById(`status-${currentIndex}`).innerText = "ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
                    speakSimple("Ø§Ø¨Ø¯Ø£"); 
                } catch(e) { speakSimple("Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ† ØºÙŠØ± Ù…ØªØ§Ø­"); }
            } else {
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                if (mediaRecorder) {
                    mediaRecorder.stop();
                    isRecording = false;
                    document.getElementById(`status-${currentIndex}`).innerText = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ù…Ø¤Ù‚ØªØ§Ù‹)";
                    speakSimple("ØªÙ…");
                }
            }
        }

        function stopRecordingIfActive() {
            if (isRecording && mediaRecorder) {
                mediaRecorder.stop();
                isRecording = false;
            }
        }

        function speakSimple(msg) {
            window.speechSynthesis.cancel();
            let u = new SpeechSynthesisUtterance(msg);
            u.lang = 'ar-SA';
            u.rate = 1.2;
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>