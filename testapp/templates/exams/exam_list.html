{% load static %} <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>قائمة الاختبارات</title>
    <style>
        /* إعدادات الخلفية */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 70px; 
            text-align: center;
            min-height: 100vh;
            position: relative; /* ضروري عشان الخلفية */
            overflow-x: hidden;
        }

        /* الطبقة الشفافة للصورة (هذا هو كود الخلفية الخفيفة) */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* غير اسم الصورة هنا لاسم صورة المعهد عندك */
            background-image: url('{% static "logo.PNG" %}'); 
            background-size: cover;
            background-position: left 100px center;
            background-repeat: no-repeat;
            opacity: 0.10; /* درجة الشفافية (10% خفيف جداً) */
            z-index: -1; /* عشان تكون ورا الكلام */
        }

        .highlight { 
            border: 5px solid #007bff; 
            background-color: #fff; /* خلفية بيضاء عشان الكلام يبان فوق الصورة */
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        .exam-card { 
            padding: 20px; 
            background: rgba(255, 255, 255, 0.9); /* خلفية بيضاء شبه شفافة للكارت */
            margin-bottom: 20px; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
            transition: all 0.3s; 
        }

        .instructions { 
            background: #333; 
            color: #fff; 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 5px; 
            font-size: 1.2em; 
            border: 2px solid gold;
        }

        h2 { color: #0056b3; margin-bottom: 10px; }
        audio { display: none; }
    </style>
</head>
<body>

    <div class="instructions" id="welcome-msg">
        مرحباً بك. اضغط على زر "المسافة" للتنقل وسماع أسماء الاختبارات بصوت واضح. اضغط "إنتر" للدخول.
    </div>

    <h1>الاختبارات المتاحة</h1>

    <div id="exams-container">
        {% for exam in exams %}
            <div class="exam-card" id="exam-{{ forloop.counter0 }}" data-url="{% url 'take_exam' exam.id %}">
                <h2>{{ exam.title }}</h2>
                <p>{{ exam.description }}</p>
                
                {% if exam.short_audio %}
                    <audio id="audio-{{ forloop.counter0 }}" src="{{ exam.short_audio.url }}"></audio>
                {% else %}
                    {% if exam.audio_file %}
                        <audio id="audio-{{ forloop.counter0 }}" src="{{ exam.audio_file.url }}"></audio>
                    {% endif %}
                {% endif %}
            </div>
        {% empty %}
            <div class="exam-card">
                <p>لا يوجد اختبارات حالياً.</p>
            </div>
        {% endfor %}
    </div>

    <script>
        // --- دوال التحكم في الصوت ---
        function stopAllAudio() {
            document.querySelectorAll('audio').forEach(a => {
                a.pause();
                a.currentTime = 0;
            });
            window.speechSynthesis.cancel();
        }

        function playExamAudio(index) {
            let audio = document.getElementById(`audio-${index}`);
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log("يحتاج تفاعل لتشغيل الصوت"));
            } else {
                speakSimple("ملف الصوت غير متوفر");
            }
        }

        function speakSimple(text) {
            window.speechSynthesis.cancel();
            let u = new SpeechSynthesisUtterance(text);
            u.lang = 'ar-SA';
            window.speechSynthesis.speak(u);
        }

        // --- تصحيح الخطأ هنا ---
        window.onload = function() {
            setTimeout(() => {
                // الآن نأخذ النص من الـ div بدلاً من كتابته يدوياً
                let welcomeText = document.getElementById('welcome-msg').innerText;
                speakSimple(welcomeText);
            }, 500);
        };

        // --- التحكم بالكيبورد ---
        const exams = document.querySelectorAll('.exam-card');
        let currentIndex = -1; 

        document.addEventListener('keydown', function(event) {
            
            if (event.code === 'Space') {
                event.preventDefault(); 
                stopAllAudio();

                if (currentIndex >= 0 && currentIndex < exams.length) {
                    exams[currentIndex].classList.remove('highlight');
                }

                currentIndex++;
                if (currentIndex >= exams.length) {
                    currentIndex = 0; 
                    speakSimple("الأول");
                }

                let currentExam = exams[currentIndex];
                currentExam.classList.add('highlight');
                currentExam.scrollIntoView({ behavior: 'smooth', block: 'center' });

                setTimeout(() => {
                    playExamAudio(currentIndex);
                }, 100);
            }

            if (event.code === 'Enter') {
                if (currentIndex >= 0) {
                    stopAllAudio();
                    speakSimple("جاري الدخول...");
                    let url = exams[currentIndex].getAttribute('data-url');
                    setTimeout(() => { window.location.href = url; }, 1000);
                }
            }
        });
    </script>
</body>
</html>